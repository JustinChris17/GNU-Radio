#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
This script generates a GNU Radio Companion (GRC) flowgraph for a
HackRF burst transmitter that's compatible with modern GNU Radio versions.
"""

import os
import yaml
import random

# Define the output file
output_file = "hackrf_burst_transmitter.grc"

# Create a dictionary representing the GRC file structure
grc_dict = {
    "options": {
        "parameters": {
            "author": "Claude",
            "catch_exceptions": "True",
            "category": "Custom",
            "cmake_opt": "",
            "comment": "",
            "copyright": "",
            "description": "HackRF Burst Transmitter to match provided receiver",
            "gen_cmake": "Yes",
            "gen_linking": "dynamic",
            "generate_options": "qt_gui",
            "hier_block_src_path": ".:",
            "id": "hackrf_burst_transmitter",
            "max_nouts": "0",
            "output_language": "python",
            "placement": "(0,0)",
            "qt_qss_theme": "",
            "realtime_scheduling": "",
            "run": "True",
            "run_command": "{python} -u {filename}",
            "run_options": "prompt",
            "sizing_mode": "fixed",
            "thread_safe_setters": "",
            "title": "HackRF Burst Transmitter",
        },
        "states": {
            "bus_sink": "False",
            "bus_source": "False",
            "bus_structure": "null",
            "coordinate": "[8, 8]",
            "rotation": "0",
            "state": "enabled",
        },
    },
    "blocks": [
        # Variables
        {
            "name": "variable",
            "id": "samp_rate",
            "parameters": {
                "comment": "",
                "value": "4e6",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[8, 160]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "variable",
            "id": "center_freq",
            "parameters": {
                "comment": "",
                "value": "434e6",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[8, 224]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "variable",
            "id": "cutoff_freq",
            "parameters": {
                "comment": "",
                "value": "12.5e3",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[8, 288]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "variable",
            "id": "tx_gain",
            "parameters": {
                "comment": "",
                "value": "20",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[112, 160]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "variable",
            "id": "if_gain",
            "parameters": {
                "comment": "",
                "value": "20",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[112, 224]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "variable",
            "id": "bb_gain",
            "parameters": {
                "comment": "",
                "value": "20",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[112, 288]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "variable",
            "id": "burst_length",
            "parameters": {
                "comment": "",
                "value": "1000",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[216, 160]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "variable",
            "id": "burst_period",
            "parameters": {
                "comment": "",
                "value": "10000",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[216, 224]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        # Blocks
        {
            "name": "blocks_vector_source_b",
            "id": "blocks_vector_source_b_0",
            "parameters": {
                "comment": "Random Data Source",
                "maxoutbuf": "0",
                "minoutbuf": "0",
                "repeat": "True",
                "tags": "[]",
                "type": "byte",
                "vector": "[random.randint(0,255) for _ in range(1000)]",
                "vlen": "1",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[24, 356]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "blocks_packed_to_unpacked_xx",
            "id": "blocks_packed_to_unpacked_xx_0",
            "parameters": {
                "bits_per_chunk": "1",
                "comment": "Convert bytes to bits",
                "endianness": "gr.GR_MSB_FIRST",
                "maxoutbuf": "0",
                "minoutbuf": "0",
                "num_ports": "1",
                "type": "byte",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[224, 364]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "digital_gfsk_mod",
            "id": "digital_gfsk_mod_0",
            "parameters": {
                "bt": "0.35",
                "comment": "GFSK Modulator (matches receiver)",
                "log": "False",
                "maxoutbuf": "0",
                "minoutbuf": "0",
                "samples_per_symbol": "2",
                "sensitivity": "1.0",
                "verbose": "False",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[448, 356]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "low_pass_filter",
            "id": "low_pass_filter_0",
            "parameters": {
                "beta": "6.76",
                "comment": "Filter to match receiver LPF",
                "cutoff_freq": "cutoff_freq",
                "decim": "1",
                "gain": "1",
                "interp": "1",
                "maxoutbuf": "0",
                "minoutbuf": "0",
                "samp_rate": "samp_rate",
                "type": "fir_filter_ccf",
                "width": "cutoff_freq*0.1",
                "win": "window.WIN_HAMMING",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[656, 332]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "blocks_vector_source_b",
            "id": "blocks_vector_source_b_1",
            "parameters": {
                "comment": "Burst Control Pattern",
                "maxoutbuf": "0",
                "minoutbuf": "0",
                "repeat": "True",
                "tags": "[]",
                "type": "byte",
                "vector": "([1] * burst_length + [0] * (burst_period - burst_length)) * 10",
                "vlen": "1",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[424, 500]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "blocks_burst_tagger",
            "id": "blocks_burst_tagger_0",
            "parameters": {
                "comment": "Controls burst transmission",
                "false_key": "burst",
                "false_offset": "0",
                "false_value": "False",
                "maxoutbuf": "0",
                "minoutbuf": "0",
                "true_key": "burst",
                "true_offset": "0",
                "true_value": "True",
                "type": "complex",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[856, 356]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "blocks_throttle",
            "id": "blocks_throttle_0",
            "parameters": {
                "comment": "Throttle to control sample rate",
                "ignoretag": "True",
                "maxoutbuf": "0",
                "minoutbuf": "0",
                "samples_per_second": "samp_rate",
                "type": "complex",
                "vlen": "1",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[1040, 364]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "blocks_multiply_const_vxx",
            "id": "blocks_multiply_const_vxx_0",
            "parameters": {
                "comment": "Adjust signal level",
                "const": "1.0",
                "maxoutbuf": "0",
                "minoutbuf": "0",
                "type": "complex",
                "vlen": "1",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[1208, 364]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "osmosdr_sink",
            "id": "osmosdr_sink_0",
            "parameters": {
                "args": "hackrf=0",
                "bandwidth": "samp_rate",
                "bb_gain0": "bb_gain",
                "bb_gain1": "20",
                "bb_gain10": "20",
                "bb_gain11": "20",
                "bb_gain12": "20",
                "bb_gain13": "20",
                "bb_gain14": "20",
                "bb_gain15": "20",
                "bb_gain16": "20",
                "bb_gain17": "20",
                "bb_gain18": "20",
                "bb_gain19": "20",
                "bb_gain2": "20",
                "bb_gain20": "20",
                "bb_gain21": "20",
                "bb_gain22": "20",
                "bb_gain23": "20",
                "bb_gain24": "20",
                "bb_gain25": "20",
                "bb_gain26": "20",
                "bb_gain27": "20",
                "bb_gain28": "20",
                "bb_gain29": "20",
                "bb_gain3": "20",
                "bb_gain30": "20",
                "bb_gain31": "20",
                "bb_gain4": "20",
                "bb_gain5": "20",
                "bb_gain6": "20",
                "bb_gain7": "20",
                "bb_gain8": "20",
                "bb_gain9": "20",
                "center_freq0": "center_freq",
                "center_freq1": "100e6",
                "center_freq10": "100e6",
                "center_freq11": "100e6",
                "center_freq12": "100e6",
                "center_freq13": "100e6",
                "center_freq14": "100e6",
                "center_freq15": "100e6",
                "center_freq16": "100e6",
                "center_freq17": "100e6",
                "center_freq18": "100e6",
                "center_freq19": "100e6",
                "center_freq2": "100e6",
                "center_freq20": "100e6",
                "center_freq21": "100e6",
                "center_freq22": "100e6",
                "center_freq23": "100e6",
                "center_freq24": "100e6",
                "center_freq25": "100e6",
                "center_freq26": "100e6",
                "center_freq27": "100e6",
                "center_freq28": "100e6",
                "center_freq29": "100e6",
                "center_freq3": "100e6",
                "center_freq30": "100e6",
                "center_freq31": "100e6",
                "center_freq4": "100e6",
                "center_freq5": "100e6",
                "center_freq6": "100e6",
                "center_freq7": "100e6",
                "center_freq8": "100e6",
                "center_freq9": "100e6",
                "clock_rate": "0.0",
                "clock_source0": "",
                "clock_source1": "",
                "clock_source2": "",
                "clock_source3": "",
                "clock_source4": "",
                "clock_source5": "",
                "clock_source6": "",
                "clock_source7": "",
                "comment": "HackRF One Transmitter",
                "corr0": "0",
                "corr1": "0",
                "corr10": "0",
                "corr11": "0",
                "corr12": "0",
                "corr13": "0",
                "corr14": "0",
                "corr15": "0",
                "corr16": "0",
                "corr17": "0",
                "corr18": "0",
                "corr19": "0",
                "corr2": "0",
                "corr20": "0",
                "corr21": "0",
                "corr22": "0",
                "corr23": "0",
                "corr24": "0",
                "corr25": "0",
                "corr26": "0",
                "corr27": "0",
                "corr28": "0",
                "corr29": "0",
                "corr3": "0",
                "corr30": "0",
                "corr31": "0",
                "corr4": "0",
                "corr5": "0",
                "corr6": "0",
                "corr7": "0",
                "corr8": "0",
                "corr9": "0",
                "freq0": "0",
                "freq1": "0",
                "freq10": "0",
                "freq11": "0",
                "freq12": "0",
                "freq13": "0",
                "freq14": "0",
                "freq15": "0",
                "freq16": "0",
                "freq17": "0",
                "freq18": "0",
                "freq19": "0",
                "freq2": "0",
                "freq20": "0",
                "freq21": "0",
                "freq22": "0",
                "freq23": "0",
                "freq24": "0",
                "freq25": "0",
                "freq26": "0",
                "freq27": "0",
                "freq28": "0",
                "freq29": "0",
                "freq3": "0",
                "freq30": "0",
                "freq31": "0",
                "freq4": "0",
                "freq5": "0",
                "freq6": "0",
                "freq7": "0",
                "freq8": "0",
                "freq9": "0",
                "gain0": "tx_gain",
                "gain1": "0",
                "gain10": "0",
                "gain11": "0",
                "gain12": "0",
                "gain13": "0",
                "gain14": "0",
                "gain15": "0",
                "gain16": "0",
                "gain17": "0",
                "gain18": "0",
                "gain19": "0",
                "gain2": "0",
                "gain20": "0",
                "gain21": "0",
                "gain22": "0",
                "gain23": "0",
                "gain24": "0",
                "gain25": "0",
                "gain26": "0",
                "gain27": "0",
                "gain28": "0",
                "gain29": "0",
                "gain3": "0",
                "gain30": "0",
                "gain31": "0",
                "gain4": "0",
                "gain5": "0",
                "gain6": "0",
                "gain7": "0",
                "gain8": "0",
                "gain9": "0",
                "if_gain0": "if_gain",
                "if_gain1": "0",
                "if_gain10": "0",
                "if_gain11": "0",
                "if_gain12": "0",
                "if_gain13": "0",
                "if_gain14": "0",
                "if_gain15": "0",
                "if_gain16": "0",
                "if_gain17": "0",
                "if_gain18": "0",
                "if_gain19": "0",
                "if_gain2": "0",
                "if_gain20": "0",
                "if_gain21": "0",
                "if_gain22": "0",
                "if_gain23": "0",
                "if_gain24": "0",
                "if_gain25": "0",
                "if_gain26": "0",
                "if_gain27": "0",
                "if_gain28": "0",
                "if_gain29": "0",
                "if_gain3": "0",
                "if_gain30": "0",
                "if_gain31": "0",
                "if_gain4": "0",
                "if_gain5": "0",
                "if_gain6": "0",
                "if_gain7": "0",
                "if_gain8": "0",
                "if_gain9": "0",
                "maxoutbuf": "0",
                "minoutbuf": "0",
                "nchan": "1",
                "num_mboards": "1",
                "sample_rate": "samp_rate",
                "sync": "sync",
                "time_source0": "",
                "time_source1": "",
                "time_source2": "",
                "time_source3": "",
                "time_source4": "",
                "time_source5": "",
                "time_source6": "",
                "time_source7": "",
                "type": "fc32",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[1424, 108]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "qtgui_waterfall_sink_x",
            "id": "qtgui_waterfall_sink_x_0",
            "parameters": {
                "bw": "samp_rate",
                "color1": "3",
                "color10": "0",
                "color2": "0",
                "color3": "0",
                "color4": "0",
                "color5": "0",
                "color6": "0",
                "color7": "0",
                "color8": "0",
                "color9": "0",
                "comment": "Waterfall display for monitoring",
                "fc": "center_freq",
                "fftsize": "1024",
                "freqhalf": "True",
                "grid": "False",
                "gui_hint": "",
                "int_max": "10",
                "int_min": "-140",
                "label1": "",
                "label10": "",
                "label2": "",
                "label3": "",
                "label4": "",
                "label5": "",
                "label6": "",
                "label7": "",
                "label8": "",
                "label9": "",
                "legend": "True",
                "maxoutbuf": "0",
                "minoutbuf": "0",
                "name": "Transmitted Signal Spectrum",
                "nconnections": "1",
                "showports": "True",
                "type": "complex",
                "update_time": "0.10",
                "wintype": "window.WIN_BLACKMAN_hARRIS",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[1424, 364]",
                "rotation": "0",
                "state": "enabled",
            },
        },
        {
            "name": "qtgui_time_sink_x",
            "id": "qtgui_time_sink_x_0",
            "parameters": {
                "alpha1": "1.0",
                "alpha10": "1.0",
                "alpha2": "1.0",
                "alpha3": "1.0",
                "alpha4": "1.0",
                "alpha5": "1.0",
                "alpha6": "1.0",
                "alpha7": "1.0",
                "alpha8": "1.0",
                "alpha9": "1.0",
                "autoscale": "False",
                "axislabels": "True",
                "color1": "blue",
                "color10": "dark blue",
                "color2": "red",
                "color3": "green",
                "color4": "black",
                "color5": "cyan",
                "color6": "magenta",
                "color7": "yellow",
                "color8": "dark red",
                "color9": "dark green",
                "comment": "Time domain display",
                "ctrlpanel": "False",
                "entags": "True",
                "grid": "False",
                "gui_hint": "",
                "label1": "Real",
                "label10": "",
                "label2": "Imag",
                "label3": "",
                "label4": "",
                "label5": "",
                "label6": "",
                "label7": "",
                "label8": "",
                "label9": "",
                "legend": "True",
                "marker1": "-1",
                "marker10": "-1",
                "marker2": "-1",
                "marker3": "-1",
                "marker4": "-1",
                "marker5": "-1",
                "marker6": "-1",
                "marker7": "-1",
                "marker8": "-1",
                "marker9": "-1",
                "maxoutbuf": "0",
                "minoutbuf": "0",
                "name": "Transmitted Signal",
                "nconnections": "1",
                "size": "burst_period * 2",
                "srate": "samp_rate",
                "stemplot": "False",
                "style1": "1",
                "style10": "1",
                "style2": "1",
                "style3": "1",
                "style4": "1",
                "style5": "1",
                "style6": "1",
                "style7": "1",
                "style8": "1",
                "style9": "1",
                "tr_chan": "0",
                "tr_delay": "0",
                "tr_level": "0.0",
                "tr_mode": "qtgui.TRIG_MODE_FREE",
                "tr_slope": "qtgui.TRIG_SLOPE_POS",
                "tr_tag": "\"\"",
                "type": "complex",
                "update_time": "0.10",
                "width1": "1",
                "width10": "1",
                "width2": "1",
                "width3": "1",
                "width4": "1",
                "width5": "1",
                "width6": "1",
                "width7": "1",
                "width8": "1",
                "width9": "1",
                "ylabel": "Amplitude",
                "ymax": "1",
                "ymin": "-1",
                "yunit": "\"\"",
            },
            "states": {
                "bus_sink": "False",
                "bus_source": "False",
                "bus_structure": "null",
                "coordinate": "[1424, 468]",
                "rotation": "0",
                "state": "enabled",
            },
        },
    ],
    "connections": [
        ["blocks_vector_source_b_0", "0", "blocks_packed_to_unpacked_xx_0", "0"],
        ["blocks_packed_to_unpacked_xx_0", "0", "digital_gfsk_mod_0", "0"],
        ["digital_gfsk_mod_0", "0", "low_pass_filter_0", "0"],
        ["low_pass_filter_0", "0", "blocks_burst_tagger_0", "0"],
        ["blocks_vector_source_b_1", "0", "blocks_burst_tagger_0", "1"],
        ["blocks_burst_tagger_0", "0", "blocks_throttle_0", "0"],
        ["blocks_throttle_0", "0", "blocks_multiply_const_vxx_0", "0"],
        ["blocks_multiply_const_vxx_0", "0", "osmosdr_sink_0", "0"],
        ["blocks_multiply_const_vxx_0", "0", "qtgui_waterfall_sink_x_0", "0"],
        ["blocks_multiply_const_vxx_0", "0", "qtgui_time_sink_x_0", "0"],
    ],
    "metadata": {
        "file_format": 1,
    },
}

# Write the GRC file
with open(output_file, 'w') as f:
    yaml.dump(grc_dict, f, default_flow_style=False)

print(f"GNU Radio Companion flowgraph saved to {output_file}")
print("To use this flowgraph:")
print("1. Open GNU Radio Companion")
print("2. File -> Open -> Select the generated .grc file")
print("3. Generate the flowgraph (F5)")
print("4. Execute the flowgraph (F6)")